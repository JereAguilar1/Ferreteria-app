{% extends "base.html" %}

{% block title %}Editar Boleta {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-pencil-square"></i> Editar Boleta {{ invoice.invoice_number }}
        </h1>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('invoices.view_invoice', invoice_id=invoice.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Detalle
        </a>
    </div>
</div>

<form method="POST" id="invoice-edit-form" action="{{ url_for('invoices.save_invoice_edit', invoice_id=invoice.id) }}">
    <div class="row">
        <!-- Header Section -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Datos de la Boleta</h5>
                </div>
                <div class="card-body">
                    <!-- Supplier -->
                    <div class="mb-3">
                        <label for="supplier_id" class="form-label">
                            Proveedor <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="supplier_id" name="supplier_id" required>
                            <option value="">Seleccione proveedor...</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}" {% if invoice.supplier_id==supplier.id %}selected{% endif
                                %}>
                                {{ supplier.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Invoice Number -->
                    <div class="mb-3">
                        <label for="invoice_number" class="form-label">
                            Número de Boleta <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="invoice_number" name="invoice_number"
                            value="{{ invoice.invoice_number }}" required>
                    </div>

                    <!-- Dates -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="invoice_date" class="form-label">
                                    Fecha Boleta <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="invoice_date" name="invoice_date"
                                    value="{{ invoice.invoice_date.strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">Vencimiento</label>
                                <input type="date" class="form-control" id="due_date" name="due_date"
                                    value="{% if invoice.due_date %}{{ invoice.due_date.strftime('%Y-%m-%d') }}{% endif %}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Item Section -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Agregar Ítem</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="new_product_id" class="form-label">Producto</label>
                        <select class="form-select" id="new_product_id">
                            <option value="">Seleccione producto...</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" data-name="{{ product.name }}"
                                data-sku="{{ product.sku or '' }}" data-uom="{{ product.uom.symbol }}">
                                {{ product.name }} ({{ product.sku or 'Sin SKU' }}) - {{ product.uom.symbol }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="new_qty" class="form-label">Cantidad</label>
                                <input type="text" class="form-control number-input" id="new_qty" value="1"
                                    inputmode="decimal" autocomplete="off" placeholder="1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="new_unit_cost" class="form-label">Costo Unitario</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control money-input" id="new_unit_cost" value="0,00"
                                        inputmode="decimal" autocomplete="off" placeholder="0,00">
                                </div>
                                <small class="text-muted">Formato: 1.234,56 (Neto)</small>
                            </div>
                        </div>
                    </div>

                    <div class="row align-items-end mb-3">
                        <div class="col-md-6">
                            <label for="new_vat_rate" class="form-label">Alícuota IVA</label>
                            <select class="form-select" id="new_vat_rate">
                                <option value="0" selected>Sin IVA</option>
                                <option value="10.5">10,5%</option>
                                <option value="21">21%</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-success w-100" id="add-line-btn">
                                <i class="bi bi-plus-circle"></i> Agregar Ítem
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lines Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">Ítems de la Boleta</h5>
                </div>
                <div class="card-body">
                    <div id="lines-container">
                        {% for line in invoice.lines %}
                        <div class="line-item mb-3 p-3 border rounded" data-line-index="{{ loop.index0 }}">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <input type="hidden" name="lines[{{ loop.index0 }}][product_id]"
                                        value="{{ line.product_id }}">
                                    <strong>{{ line.product.name }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        SKU: {{ line.product.sku or '-' }} |
                                        {{ line.product.uom.symbol }}
                                    </small>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Cantidad</label>
                                    <input type="text" class="form-control form-control-sm line-qty number-input"
                                        name="lines[{{ loop.index0 }}][qty]" value="{{ line.qty|num_ar }}"
                                        inputmode="decimal" autocomplete="off" required
                                        onchange="updateLineSubtotal(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Neto Unit.</label>
                                    <input type="text" class="form-control form-control-sm line-unit-cost money-input"
                                        name="lines[{{ loop.index0 }}][unit_cost]"
                                        value="{{ line.unit_cost|money_ar_2 }}" inputmode="decimal" autocomplete="off"
                                        required onchange="updateLineSubtotal(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Alícuota IVA</label>
                                    <select class="form-select form-select-sm line-vat-rate"
                                        name="lines[{{ loop.index0 }}][vat_rate]" onchange="updateLineSubtotal(this)">
                                        <option value="0" {% if line.vat_rate==0 %}selected{% endif %}>Sin IVA</option>
                                        <option value="10.5" {% if line.vat_rate==10.5 %}selected{% endif %}>10,5%
                                        </option>
                                        <option value="21" {% if line.vat_rate==21 %}selected{% endif %}>21%</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Subtotal</label>
                                    <input type="text" class="form-control form-control-sm line-subtotal"
                                        value="${{ line.line_total|money_ar_2 }}" readonly
                                        style="background-color: #e9ecef;">
                                </div>
                                <div class="col-md-1 text-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-line-btn"
                                        title="Eliminar línea">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {% if not invoice.lines %}
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle"></i>
                        <p class="mb-0">No hay ítems agregados</p>
                    </div>
                    {% endif %}

                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Total: <span id="total-amount" class="text-primary">${{
                                        invoice.total_amount|money_ar_2 }}</span></h5>
                            </div>
                            <div>
                                <button type="button" class="btn btn-primary btn-lg" id="preview-btn"
                                    hx-post="{{ url_for('invoices.edit_invoice_preview', invoice_id=invoice.id) }}"
                                    hx-target="#invoice-edit-modal-container" hx-swap="innerHTML"
                                    hx-include="#invoice-edit-form" hx-indicator="#preview-loading">
                                    <i class="bi bi-eye"></i> Revisar y Guardar
                                </button>
                                <div id="preview-loading" class="htmx-indicator ms-2 d-inline-block">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Modal Container for HTMX -->
<div id="invoice-edit-modal-container"></div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let lineIndex = {{ invoice.lines| length
    }};
    const linesContainer = document.getElementById('lines-container');
    const newProductSelect = document.getElementById('new_product_id');
    const newQtyInput = document.getElementById('new_qty');
    const newUnitCostInput = document.getElementById('new_unit_cost');
    const newVatRateSelect = document.getElementById('new_vat_rate');
    const addLineBtn = document.getElementById('add-line-btn');

    function formatMoneyAr(value, forceDecimals) {
        const stringValue = value === undefined || value === null ? '' : String(value);
        const cleaned = stringValue.replace(/\./g, '').replace(/[^0-9,]/g, '');
        const [rawInt, rawDec = ''] = cleaned.split(',');
        const intPart = rawInt.replace(/^0+(?=\d)/, '') || '0';
        const decPart = rawDec.slice(0, 2);
        const intFormatted = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        if (forceDecimals) {
            const padded = (decPart + '00').slice(0, 2);
            return `${intFormatted},${padded}`;
        }
        return decPart ? `${intFormatted},${decPart}` : intFormatted;
    }

    function formatNumberAr(value) {
        const stringValue = value === undefined || value === null ? '' : String(value);
        const cleaned = stringValue.replace(/\./g, '').replace(/[^0-9,]/g, '');
        const [rawInt, rawDec = ''] = cleaned.split(',');
        const intPart = rawInt.replace(/^0+(?=\d)/, '') || '0';
        const decPart = rawDec;
        const intFormatted = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return decPart ? `${intFormatted},${decPart}` : intFormatted;
    }

    function numberToMoneyAr(num) {
        const numeric = Number(num) || 0;
        const fixed = numeric.toFixed(2).replace('.', ',');
        return formatMoneyAr(fixed, true);
    }

    function numberToAr(num) {
        const numeric = Number(num) || 0;
        const str = numeric.toString();
        if (str.includes('.')) {
            const [intPart, decPart] = str.split('.');
            const intFormatted = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return `${intFormatted},${decPart}`;
        } else {
            const intFormatted = str.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return intFormatted;
        }
    }

    function arToNumber(value) {
        if (value === undefined || value === null) return 0;
        const cleaned = value.toString().replace(/\./g, '').replace(',', '.').replace(/[^0-9.-]/g, '');
        const parsed = parseFloat(cleaned);
        return isNaN(parsed) ? 0 : parsed;
    }

    function attachMoneyInput(input) {
        const onInput = () => { input.value = formatMoneyAr(input.value, false); };
        const onBlur = () => { input.value = formatMoneyAr(input.value, true); };
        input.addEventListener('input', onInput);
        input.addEventListener('blur', onBlur);
        onBlur();
    }

    function attachNumberInput(input) {
        const onInput = () => { input.value = formatNumberAr(input.value); };
        const onBlur = () => { input.value = formatNumberAr(input.value); };
        input.addEventListener('input', onInput);
        input.addEventListener('blur', onBlur);
        onBlur();
    }

    document.querySelectorAll('.money-input').forEach(attachMoneyInput);
    document.querySelectorAll('.number-input').forEach(attachNumberInput);

    // Add new line
    addLineBtn.addEventListener('click', function () {
        const productId = newProductSelect.value;
        const qtyNumber = arToNumber(newQtyInput.value);
        const unitCostNumber = arToNumber(newUnitCostInput.value);
        const vatRateNumber = parseFloat(newVatRateSelect.value) || 0;

        if (!productId) {
            alert('Debe seleccionar un producto');
            return;
        }

        if (!qtyNumber || qtyNumber <= 0) {
            alert('La cantidad debe ser mayor a 0');
            return;
        }

        if (unitCostNumber < 0) {
            alert('El costo unitario no puede ser negativo');
            return;
        }

        const selectedOption = newProductSelect.options[newProductSelect.selectedIndex];
        const productName = selectedOption.dataset.name;
        const productSku = selectedOption.dataset.sku || '-';
        const productUom = selectedOption.dataset.uom;

        // Check if product already exists in lines
        const existingLines = linesContainer.querySelectorAll('[name*="[product_id]"]');
        for (let input of existingLines) {
            if (input.value == productId) {
                alert('Este producto ya está en los ítems. Modifique la cantidad del ítem existente.');
                return;
            }
        }

        const formattedQty = formatNumberAr(newQtyInput.value);
        const formattedCost = formatMoneyAr(newUnitCostInput.value, true);
        const subtotalNumber = qtyNumber * unitCostNumber * (1 + vatRateNumber / 100);
        const subtotalFormatted = numberToMoneyAr(subtotalNumber);

        // Create line HTML
        const lineHtml = `
            <div class="line-item mb-3 p-3 border rounded" data-line-index="${lineIndex}">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <input type="hidden" name="lines[${lineIndex}][product_id]" value="${productId}">
                        <strong>${productName}</strong>
                        <br>
                        <small class="text-muted">SKU: ${productSku} | ${productUom}</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Cantidad</label>
                        <input type="text" 
                               class="form-control form-control-sm line-qty number-input" 
                               name="lines[${lineIndex}][qty]"
                               value="${formattedQty}"
                               inputmode="decimal"
                               autocomplete="off"
                               required
                               onchange="updateLineSubtotal(this)">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Neto Unit.</label>
                        <input type="text" 
                               class="form-control form-control-sm line-unit-cost money-input" 
                               name="lines[${lineIndex}][unit_cost]"
                               value="${formattedCost}"
                               inputmode="decimal"
                               autocomplete="off"
                               required
                               onchange="updateLineSubtotal(this)">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Alícuota IVA</label>
                        <select class="form-select form-select-sm line-vat-rate" 
                                name="lines[${lineIndex}][vat_rate]"
                                onchange="updateLineSubtotal(this)">
                            <option value="0" ${vatRateNumber === 0 ? 'selected' : ''}>Sin IVA</option>
                            <option value="10.5" ${vatRateNumber === 10.5 ? 'selected' : ''}>10,5%</option>
                            <option value="21" ${vatRateNumber === 21 ? 'selected' : ''}>21%</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Subtotal</label>
                        <input type="text" 
                               class="form-control form-control-sm line-subtotal" 
                               value="$${subtotalFormatted}"
                               readonly
                               style="background-color: #e9ecef;">
                    </div>
                    <div class="col-md-1 text-center">
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger remove-line-btn"
                                title="Eliminar línea">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        linesContainer.insertAdjacentHTML('beforeend', lineHtml);

        const newCostInput = linesContainer.querySelector(`[data-line-index="${lineIndex}"] .line-unit-cost`);
        if (newCostInput) {
            attachMoneyInput(newCostInput);
        }

        const newQtyInputLine = linesContainer.querySelector(`[data-line-index="${lineIndex}"] .line-qty`);
        if (newQtyInputLine) {
            attachNumberInput(newQtyInputLine);
        }

        // Reset form
        newProductSelect.value = '';
        newQtyInput.value = '1';
        attachNumberInput(newQtyInput);
        newUnitCostInput.value = formatMoneyAr('0', true);

        // Update total
        updateTotal();
        lineIndex++;
    });

    // Remove line
    linesContainer.addEventListener('click', function (e) {
        if (e.target.closest('.remove-line-btn')) {
            const lineItem = e.target.closest('.line-item');
            lineItem.remove();
            reindexLines();
            updateTotal();
        }
    });

    // Update line subtotal when qty or cost changes
    function updateLineSubtotal(input) {
        const lineItem = input.closest('.line-item');
        const qtyInput = lineItem.querySelector('.line-qty');
        const costInput = lineItem.querySelector('.line-unit-cost');
        const vatSelect = lineItem.querySelector('.line-vat-rate');

        const qty = arToNumber(qtyInput.value);
        const cost = arToNumber(costInput.value);
        const vatRate = parseFloat(vatSelect.value) || 0;
        const subtotal = qty * cost * (1 + vatRate / 100);

        const subtotalInput = lineItem.querySelector('.line-subtotal');
        if (subtotalInput) {
            subtotalInput.value = '$' + numberToMoneyAr(subtotal);
        }

        updateTotal();
    }
    window.updateLineSubtotal = updateLineSubtotal;

    // Reindex lines after removal
    function reindexLines() {
        const lines = linesContainer.querySelectorAll('.line-item');
        lines.forEach((line, index) => {
            line.dataset.lineIndex = index;
            const inputs = line.querySelectorAll('input[name*="lines["]');
            inputs.forEach(input => {
                const name = input.name;
                input.name = name.replace(/lines\[\d+\]/, `lines[${index}]`);
            });
        });
        lineIndex = lines.length;
    }

    // Update total
    function updateTotal() {
        const subtotals = linesContainer.querySelectorAll('.line-subtotal');
        let total = 0;
        subtotals.forEach(subtotalInput => {
            total += arToNumber(subtotalInput.value);
        });

        const totalElement = document.getElementById('total-amount');
        totalElement.textContent = '$' + numberToMoneyAr(total);
    }

    // Initialize totals on load
    updateTotal();

    // Sincronización de fechas
    const invoiceDateInput = document.getElementById('invoice_date');
    const dueDateInput = document.getElementById('due_date');

    if (invoiceDateInput && dueDateInput) {
        invoiceDateInput.addEventListener('change', function () {
            const invoiceDate = new Date(this.value + 'T00:00:00');
            if (!isNaN(invoiceDate.getTime())) {
                const dueDate = new Date(invoiceDate);
                dueDate.setMonth(dueDate.getMonth() + 1);

                const yyyy = dueDate.getFullYear();
                const mm = String(dueDate.getMonth() + 1).padStart(2, '0');
                const dd = String(dueDate.getDate()).padStart(2, '0');

                dueDateInput.value = `${yyyy}-${mm}-${dd}`;
            }
        });
    }
});
</script>
{% endblock %}
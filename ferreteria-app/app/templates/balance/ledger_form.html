{% extends "base.html" %}

{% block title %}{% if is_edit %}Editar Movimiento #{{ ledger.id }}{% else %}Nuevo Movimiento Manual{% endif %} -
Sistema Ferretería{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-{% if is_edit %}pencil{% else %}plus-circle{% endif %}"></i>
            {% if is_edit %}Editar Movimiento #{{ ledger.id }}{% else %}Nuevo Movimiento Manual{% endif %}
        </h1>
    </div>
    <div class="col text-end">
        <a href="{{ url_for('balance.list_ledger') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Libro Mayor
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Datos del Movimiento</h5>
            </div>
            <div class="card-body">
                <form method="POST"
                    action="{% if is_edit %}{{ url_for('balance.update_ledger', ledger_id=ledger.id) }}{% else %}{{ url_for('balance.create_ledger') }}{% endif %}">
                    <!-- Concept -->
                    <div class="mb-3">
                        <label for="concept" class="form-label">
                            Concepto <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="concept" name="concept" maxlength="255" required
                            placeholder="Ej: Pago de servicios, Retiro de caja, etc."
                            value="{{ ledger.concept if is_edit else '' }}">
                        <div class="form-text">
                            Breve descripción del motivo del movimiento
                        </div>
                    </div>

                    <!-- Type -->
                    <div class="mb-3">
                        <label for="type" class="form-label">
                            Tipo de Movimiento <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="">Seleccione...</option>
                            <option value="INCOME" {% if is_edit and ledger.type.value=='INCOME' %}selected{% endif %}>
                                Ingreso</option>
                            <option value="EXPENSE" {% if is_edit and ledger.type.value=='EXPENSE' %}selected{% endif
                                %}>Egreso</option>
                        </select>
                        <div id="balance-info" class="form-text mt-2" style="display: none;">
                            <span class="badge bg-info text-dark">
                                Saldo Actual: ${{ current_balance|money_ar_2 }}
                            </span>
                        </div>
                    </div>

                    <!-- MEJORA 12: Payment Method -->
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">
                            Método de Pago/Cobro <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="payment_method" name="payment_method" required>
                            <option value="CASH" {% if is_edit and ledger.payment_method=='CASH' %}selected{% elif not
                                is_edit %}selected{% endif %}>Efectivo</option>
                            <option value="TRANSFER" {% if is_edit and ledger.payment_method=='TRANSFER' %}selected{%
                                endif %}>Transferencia</option>
                        </select>
                    </div>

                    <!-- Amount -->
                    <div class="mb-3">
                        <label for="amount" class="form-label">
                            Monto <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="amount" name="amount" min="0.01" step="0.01"
                                required value="{{ ledger.amount if is_edit else '' }}">
                        </div>
                        <div id="amount-warning" class="text-danger small mt-1" style="display: none;">
                            El monto excede el saldo disponible.
                        </div>
                    </div>

                    <!-- DateTime -->
                    <div class="mb-3">
                        <label for="datetime" class="form-label">
                            Fecha y Hora
                        </label>
                        <input type="datetime-local" class="form-control" id="datetime" name="datetime"
                            value="{{ now }}">
                    </div>

                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category" class="form-label">Categoría (Opcional)</label>
                        <input type="text" class="form-control" id="category" name="category" maxlength="100"
                            placeholder="Ej: Servicios, Impuestos, etc."
                            value="{{ ledger.category if is_edit and ledger.category else '' }}">
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notas (Opcional)</label>
                        <textarea class="form-control" id="notes" name="notes"
                            rows="2">{{ ledger.notes if is_edit and ledger.notes else '' }}</textarea>
                        <div id="balance-info" class="form-text mt-2">
                            <i class="bi bi-info-circle"></i> Los movimientos manuales pueden representar fondos
                            externos.
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex justify-content-between pt-3">
                        <a href="{{ url_for('balance.list_ledger') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="submit" id="submit-btn" class="btn btn-success">
                            <i class="bi bi-save"></i> {% if is_edit %}Guardar Cambios{% else %}Registrar Movimiento{%
                            endif %}
                        </button>
                    </div>
                </form>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const submitBtn = document.getElementById('submit-btn');
                        const form = document.querySelector('form');

                        form.addEventListener('submit', function () {
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ' + (form.getAttribute('action').includes('edit') ? 'Guardando...' : 'Registrando...');
                        });
                    });
                </script>
            </div>
        </div>
    </div>

    <!-- Help Card -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="bi bi-question-circle"></i> Ayuda
                </h6>
            </div>
            <div class="card-body">
                <h6>¿Cuándo usar movimientos manuales?</h6>
                <ul class="small">
                    <li><strong>Ingresos:</strong> Otros ingresos que no provienen de ventas (ej: préstamos, aportes de
                        capital, intereses recibidos)</li>
                    <li><strong>Egresos:</strong> Otros gastos que no son pagos a proveedores (ej: servicios, sueldos,
                        impuestos, alquileres)</li>
                </ul>

                <hr>

                <h6 class="mt-3">Movimientos automáticos:</h6>
                <ul class="small mb-0">
                    <li><strong>Ventas:</strong> Se registran automáticamente al confirmar una venta</li>
                    <li><strong>Pagos a proveedores:</strong> Se registran automáticamente al pagar una boleta</li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-warning text-dark">
                <h6 class="card-title mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Importante
                </h6>
            </div>
            <div class="card-body">
                <p class="small mb-0">
                    Los movimientos manuales NO afectan el stock. Solo se registran en el libro mayor para el balance
                    financiero.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
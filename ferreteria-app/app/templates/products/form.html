{% extends "base.html" %}

{% block title %}
{% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %} - Sistema Ferretería
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-box-seam"></i> 
            {% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %}
        </h1>
    </div>
</div>

<!-- MEJORA 9: Alert if no UOMs available -->
{% if not uoms or uoms|length == 0 %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i>
    <strong>No hay unidades de medida registradas.</strong>
    <br>
    Debe crear al menos una unidad de medida antes de poder crear productos.
    <br>
    <a href="{{ url_for('settings.list_uoms') }}" class="alert-link">
        <i class="bi bi-plus-circle"></i> Ir a Unidades de Medida
    </a>
</div>
{% endif %}

<div class="row">
    <div >
        <!-- MEJORA 24: Stock Adjustment (only in edit mode) -->
        {% if action == 'edit' and product %}
        <div class="card mb-3">
            <div class="card-header text-dark">
                <h5 class="card-title mb-0">
                    <i class="bi bi-box-seam"></i> Ajuste Manual de Stock
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex align-items-center gap-2">
                    <label class="form-label mb-0"><strong>Stock Actual:</strong></label>
                    <h4 class="alert mb-0 py-1 px-2">{{ product.on_hand_qty|num_ar }} {{ product.uom.symbol }}</h4>
                  </div>
                
                <form id="stock-form" method="POST" action="{{ url_for('catalog.adjust_product_stock', product_id=product.id) }}">
                    <div class="mb-3">
                        <label for="new_stock" class="form-label">
                            Nuevo Stock
                        </label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control num-ar" 
                                   id="new_stock" 
                                   name="new_stock" 
                                   value="{{ product.on_hand_qty | num_ar}}"
                                   inputmode="decimal"
                                   step="0.01"
                                   min="0"
                                   required>
                            <span class="input-group-text">{{ product.uom.symbol }}</span>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Setear stock a un valor específico
                        </div>
                    </div>
                    
                    <button type="submit" class="btn active">
                        <i class="bi bi-arrow-repeat"></i> Aplicar Ajuste
                    </button>
                </form>
                
                <!-- Recent Adjustments Audit -->
                {% if recent_adjustments and recent_adjustments|length > 0 %}
                <div class="mt-3">
                    <h6 class="text-muted small">Últimos Ajustes Manuales:</h6>
                    <ul class="list-group list-group-flush small">
                        {% for adj in recent_adjustments %}
                        <li class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between">
                                <span>
                                    <i class="bi bi-clock"></i> {{ adj.date|datetime_ar }}
                                </span>
                                <span class="{% if adj.delta > 0 %}text-success{% elif adj.delta < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if adj.delta > 0 %}+{% endif %}{{ adj.delta|num_ar }}
                                </span>
                            </div>
                            {% if adj.notes %}
                            <div class="text-muted" style="font-size: 0.85em;">
                                {{ adj.notes }}
                            </div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Help Card -->
        <!--<div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-question-circle"></i> Ayuda
                </h5>
            </div>
            <div class="card-body">
                <h6>Campos requeridos:</h6>
                <ul class="small">
                    <li><strong>Nombre:</strong> Identificación del producto</li>
                    <li><strong>Unidad de Medida:</strong> Cómo se mide (UN, KG, M, etc.)</li>
                    <li><strong>Precio de Venta:</strong> Precio al público</li>
                </ul>
                
                <h6 class="mt-3">Campos opcionales:</h6>
                <ul class="small">
                    <li><strong>SKU:</strong> Código interno único</li>
                    <li><strong>Código de Barras:</strong> Para escaneo</li>
                    <li><strong>Categoría:</strong> Para organizar productos</li>
                    {% if action == 'new' %}
                    <li><strong>Stock Inicial:</strong> Stock al crear el producto</li>
                    {% endif %}
                </ul>

                <div class="alert alert-warning alert-sm mt-3">
                    <small>
                        <i class="bi bi-exclamation-triangle"></i>
                        El SKU y código de barras deben ser únicos si se proporcionan.
                    </small>
                </div>
            </div>
        </div>-->
    </div>
    
    <div>
        <div class="card">
            <div class="card-body">
                <form method="POST" 
                      id="product-form"
                      action="{% if action == 'new' %}{{ url_for('catalog.create_product') }}{% else %}{{ url_for('catalog.update_product', product_id=product.id) }}{% endif %}"
                      enctype="multipart/form-data">
                    
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label">
                            Nombre <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               name="name" 
                               value="{{ product.name if product else '' }}"
                               required
                               maxlength="255">
                        <div class="form-text">Nombre descriptivo del producto</div>
                    </div>

                    <!-- SKU and Barcode -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sku" class="form-label">SKU</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="sku" 
                                       name="sku" 
                                       value="{{ product.sku if product else '' }}"
                                       maxlength="100">
                                <div class="form-text">Código interno único (opcional)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="barcode" class="form-label">Código de Barras</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="barcode" 
                                       name="barcode" 
                                       value="{{ product.barcode if product else '' }}"
                                       maxlength="100">
                                <div class="form-text">Código de barras (opcional)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Category and UOM -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category_id" class="form-label">Categoría</label>
                                <select class="form-select" id="category_id" name="category_id">
                                    <option value="">Sin categoría</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" 
                                            {% if product and product.category_id == category.id %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Categoría del producto (opcional)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="uom_id" class="form-label">
                                    Unidad de Medida <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="uom_id" name="uom_id" required {% if not uoms or uoms|length == 0 %}disabled{% endif %}>
                                    <option value="">{% if uoms and uoms|length > 0 %}Seleccione una unidad{% else %}Sin unidades disponibles{% endif %}</option>
                                    {% for uom in uoms %}
                                    <option value="{{ uom.id }}" 
                                            {% if product and product.uom_id == uom.id %}selected{% endif %}>
                                        {{ uom.name }} ({{ uom.symbol }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    Unidad para medir el producto
                                    {% if not uoms or uoms|length == 0 %}
                                    <br><a href="{{ url_for('settings.list_uoms') }}" class="text-warning"><i class="bi bi-plus-circle"></i> Crear unidades de medida</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MEJORA A: UOM Prices Section -->
                    <div class="card mb-4">
                        <!--<div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-tags"></i> Unidades de Medida y Precios
                            </h6>
                        </div>-->
                        <div class="card-body">
                            <!--<p class="text-muted small mb-3">
                                <i class="bi bi-info-circle"></i>
                                Puede definir múltiples unidades de medida para el mismo producto (ej: metro, rollo).
                                Una debe ser la unidad <strong>base</strong> (para el stock).
                            </p>-->
                            
                            <!-- UOM Prices Table -->
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="uom-prices-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Unidad <span class="text-danger">*</span></th>
                                            <th>Precio Venta <span class="text-danger">*</span></th>
                                            <th>Factor Conversión <span class="text-danger">*</span></th>
                                            <th>¿Base?</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="uom-prices-tbody">
                                        {% if product and product.uom_prices %}
                                            {% for uom_price in product.uom_prices %}
                                            <tr class="uom-price-row">
                                                <td>
                                                    <select class="form-select form-select-sm uom-select" name="uom_prices[{{ loop.index0 }}][uom_id]" required>
                                                        <option value="">Seleccione...</option>
                                                        {% for uom in uoms %}
                                                        <option value="{{ uom.id }}" {% if uom.id == uom_price.uom_id %}selected{% endif %}>
                                                            {{ uom.name }} ({{ uom.symbol }})
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm num-ar" 
                                                           name="uom_prices[{{ loop.index0 }}][sale_price]" 
                                                           value="{{ uom_price.sale_price | num_ar}}"
                                                           inputmode="decimal"
                                                           step="0.1" min="0" required>
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm num-ar" 
                                                           name="uom_prices[{{ loop.index0 }}][conversion_to_base]" 
                                                           value="{{ uom_price.conversion_to_base | num_ar}}"
                                                           inputmode="decimal"
                                                           step="0.1" min="0.1" required>
                                                </td>
                                                <td class="text-center">
                                                    <input type="radio" class="form-check-input is-base-radio" 
                                                           name="uom_base_index" 
                                                           value="{{ loop.index0 }}"
                                                           {% if uom_price.is_base %}checked{% endif %} required>
                                                </td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-uom-btn" 
                                                            onclick="removeUomPriceRow(this)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <!-- Default row for new product -->
                                            <tr class="uom-price-row">
                                                <td>
                                                    <select class="form-select form-select-sm uom-select" name="uom_prices[0][uom_id]" required>
                                                        <option value="">Seleccione...</option>
                                                        {% for uom in uoms %}
                                                        <option value="{{ uom.id }}" {% if product and uom.id == product.uom_id %}selected{% endif %}>
                                                            {{ uom.name }} ({{ uom.symbol }})
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm num-ar" 
                                                           name="uom_prices[0][sale_price]" 
                                                           value="{{ (product.sale_price if product else '0.00') | num_ar}}"
                                                           step="0.01" min="0" required>
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm num-ar" 
                                                           name="uom_prices[0][conversion_to_base]" 
                                                           value="{{ 1 | num_ar }}"
                                                           step="0.01" min="0.01" required>
                                                </td>
                                                <td class="text-center">
                                                    <input type="radio" class="form-check-input is-base-radio" 
                                                           name="uom_base_index" 
                                                           value="0" checked required>
                                                </td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-uom-btn" 
                                                            onclick="removeUomPriceRow(this)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addUomPriceRow()">
                                <i class="bi bi-plus-circle"></i> Agregar Unidad
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <!-- MEJORA 11: Stock Mínimo -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="min_stock_qty" class="form-label">
                                    Stock Mínimo
                                </label>
                                <input type="text" 
                                       class="form-control num-ar" 
                                       id="min_stock_qty" 
                                       name="min_stock_qty" 
                                       value="{{ (product.min_stock_qty if product else '0') | num_ar}}"
                                       inputmode="decimal"
                                       step="0.01"
                                       min="0">
                                <div class="form-text">
                                    Umbral de stock bajo. Si es 0, el producto no se marca como "poco stock".
                                </div>
                            </div>
                        </div>
                        
                        <!-- MEJORA 24: Stock Inicial (solo en creación) -->
                        {% if action == 'new' %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="initial_stock" class="form-label">
                                    Stock Inicial
                                </label>
                                <input type="text" 
                                       class="form-control num-ar" 
                                       id="initial_stock" 
                                       name="initial_stock" 
                                       value="{{ 0 | num_ar }}"
                                       step="0.01"
                                       min="0"
                                       inputmode="decimal"
                                       placeholder="Opcional">
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Stock inicial del producto. Si no se especifica, inicia en 0.
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Estado</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="active" 
                                           name="active"
                                           {% if not product or product.active %}checked{% endif %}>
                                    <label class="form-check-label" for="active">
                                        Producto activo
                                    </label>
                                </div>
                                <div class="form-text">Los productos inactivos no aparecen en ventas</div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Image -->
                    <div class="mb-3">
                        <label for="image" class="form-label">Imagen del Producto</label>
                        {% if product and product.image_path %}
                        <div class="mb-2">
                            <img src="{{ url_for('static', filename='uploads/products/' + product.image_path) }}" 
                                 alt="{{ product.name }}"
                                 class="img-thumbnail"
                                 style="max-width: 200px; max-height: 200px;">
                            <p class="small text-muted">Imagen actual</p>
                        </div>
                        {% endif %}
                        <input type="file" 
                               class="form-control" 
                               id="image" 
                               name="image"
                               accept="image/jpeg,image/jpg,image/png">
                        <div class="form-text">
                            Formatos permitidos: JPG, JPEG, PNG. Tamaño máximo: 2MB
                            {% if product and product.image_path %}
                            <br><small class="text-info">Si selecciona una nueva imagen, reemplazará la actual</small>
                            {% endif %}
                        </div>
                    </div>

                    {% if product %}
                    <!-- Stock Info (read-only) -->
                    
                    {% endif %}

                    <!-- Actions -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('catalog.list_products') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                        <button type="submit" class="btn btn-primary" {% if not uoms or uoms|length == 0 %}disabled title="Debe crear al menos una unidad de medida"{% endif %}>
                            <i class="bi bi-save"></i> 
                            {% if action == 'new' %}Crear Producto{% else %}Guardar Cambios{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    
</div>

<script>
// MEJORA A: UOM Prices Management
let uomPriceRowIndex = {{ (product.uom_prices|length if product and product.uom_prices else 1) }};

function addUomPriceRow() {
    const tbody = document.getElementById('uom-prices-tbody');
    const newRow = document.createElement('tr');
    newRow.className = 'uom-price-row';
    newRow.innerHTML = `
        <td>
            <select class="form-select form-select-sm uom-select" name="uom_prices[\${uomPriceRowIndex}][uom_id]" required>
                <option value="">Seleccione...</option>
                {% for uom in uoms %}
                <option value="{{ uom.id }}">{{ uom.name }} ({{ uom.symbol }})</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm num-ar" 
                   name="uom_prices[\${uomPriceRowIndex}][sale_price]" 
                   value="0,00"
                   inputmode="decimal"
                   required>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm num-ar" 
                   name="uom_prices[\${uomPriceRowIndex}][conversion_to_base]" 
                   value="1,00"
                   inputmode="decimal"
                   required>
        </td>
        <td class="text-center">
            <input type="radio" class="form-check-input is-base-radio" 
                   name="uom_base_index" 
                   value="\${uomPriceRowIndex}" required>
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-uom-btn" 
                    onclick="removeUomPriceRow(this)">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    tbody.appendChild(newRow);
    
    // Attach event handlers to the new inputs
    const newInputs = newRow.querySelectorAll('.num-ar');
    newInputs.forEach(input => {
        attachNumArHandlers(input);
    });
    
    uomPriceRowIndex++;
}

function removeUomPriceRow(button) {
    const tbody = document.getElementById('uom-prices-tbody');
    const rows = tbody.querySelectorAll('.uom-price-row');
    
    // Don't allow removing the last row
    if (rows.length <= 1) {
        alert('Debe mantener al menos una unidad de medida');
        return;
    }
    
    const row = button.closest('tr');
    const wasBase = row.querySelector('.is-base-radio').checked;
    
    row.remove();
    
    // If we removed the base, set the first remaining row as base
    if (wasBase) {
        const firstRadio = tbody.querySelector('.is-base-radio');
        if (firstRadio) {
            firstRadio.checked = true;
        }
    }
    
    // Reindex rows
    reindexUomPriceRows();
}

function reindexUomPriceRows() {
    const rows = document.querySelectorAll('.uom-price-row');
    rows.forEach((row, index) => {
        // Update all input names
        row.querySelector('.uom-select').name = `uom_prices[${index}][uom_id]`;
        const salePriceInput = row.querySelector('input[name*="sale_price"]');
        if (salePriceInput) salePriceInput.name = `uom_prices[${index}][sale_price]`;
        const conversionInput = row.querySelector('input[name*="conversion_to_base"]');
        if (conversionInput) conversionInput.name = `uom_prices[${index}][conversion_to_base]`;
        row.querySelector('.is-base-radio').value = index;
    });
    uomPriceRowIndex = rows.length;
}

/* =========================
   NUM-AR: parsing robusto
   ========================= */
function parseFlexibleNumber(value) {
  if (value == null) return NaN;
  let s = String(value).trim();
  if (!s) return NaN;

  const hasComma = s.includes(',');
  const hasDot = s.includes('.');

  // AR: 1.234,56  -> 1234.56
  if (hasComma) {
    s = s.replace(/\./g, '').replace(',', '.');
    return Number(s);
  }

  // EN/normalizado: 1234.56 -> 1234.56
  // Si aparece algo como 1,234.56, quitar comas de miles.
  if (hasDot) {
    s = s.replace(/,/g, '');
    return Number(s);
  }

  // Entero: 1234
  return Number(s);
}

function formatNumberAR(value) {
  const n = parseFlexibleNumber(value);
  if (!isFinite(n)) return '';
  return n.toLocaleString('es-AR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function normalizeToBackend(value) {
  const n = parseFlexibleNumber(value);
  if (!isFinite(n)) return '';
  return n.toFixed(2); // SIEMPRE 2 decimales
}

function attachNumArHandlers(input) {
  if (!input || input.dataset.numArBound === '1') return;
  input.dataset.numArBound = '1';

  input.addEventListener('focus', function() {
    // editable en formato backend, pero sin romper decimales
    const normalized = normalizeToBackend(this.value);
    this.value = normalized || '0.00';
    this.select?.();
  });

  input.addEventListener('blur', function() {
    // display AR
    const formatted = formatNumberAR(this.value);
    this.value = formatted || '0,00';
  });

  // formatear al cargar - solo si tiene valor
  if (input.value) {
    const formatted = formatNumberAR(input.value);
    if (formatted) {
      input.value = formatted;
    }
  }
}

/* =========================
   INIT
   ========================= */
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.num-ar').forEach(attachNumArHandlers);
});

/* =========================
   SUBMIT: normalizar SOLO el form que se envía
   ========================= */
document.addEventListener('submit', function(e) {
  const form = e.target;
  
  // Solo validar el formulario de producto
  if (form.id === 'product-form') {
    // Validar UOM prices
    const rows = form.querySelectorAll('.uom-price-row');
    
    // Check at least one row
    if (rows.length === 0) {
      e.preventDefault();
      alert('Debe definir al menos una unidad de medida con precio');
      return false;
    }
    
    // Check exactly one base
    const baseRadios = form.querySelectorAll('.is-base-radio:checked');
    if (baseRadios.length !== 1) {
      e.preventDefault();
      alert('Debe seleccionar exactamente una unidad de medida como base');
      return false;
    }
    
    // Check for duplicate UOMs
    const selectedUoms = Array.from(form.querySelectorAll('.uom-select'))
      .map(select => select.value)
      .filter(value => value !== '');
    
    const uniqueUoms = new Set(selectedUoms);
    if (selectedUoms.length !== uniqueUoms.size) {
      e.preventDefault();
      alert('No puede haber unidades de medida duplicadas');
      return false;
    }
    
    // Log form data for debugging
    console.log('Submitting product form with', rows.length, 'UOM rows');
    rows.forEach((row, idx) => {
      const uomSelect = row.querySelector('.uom-select');
      const priceInput = row.querySelector('input[name*="sale_price"]');
      const convInput = row.querySelector('input[name*="conversion_to_base"]');
      console.log(`Row ${idx}:`, {
        uom: uomSelect?.value,
        price: priceInput?.value,
        conversion: convInput?.value
      });
    });
  }
  
  // Normalizar todos los inputs num-ar
  form.querySelectorAll('.num-ar').forEach(input => {
    input.value = normalizeToBackend(input.value);
  });
});


</script>




{% endblock %}


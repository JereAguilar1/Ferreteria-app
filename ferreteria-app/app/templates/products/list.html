{% extends "base.html" %}

{% block title %}Productos - Sistema Ferretería{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-box-seam"></i> Productos
        </h1>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="row mb-3">
    <div class="col-12">
        <form method="GET" action="{{ url_for('catalog.list_products') }}" class="row g-2 align-items-end">
            <!-- Category Filter -->
            <div class="col-md-2">
                <label for="category_id" class="form-label small mb-1">
                    <i class="bi bi-funnel"></i> Categoría
                </label>
                <select class="form-select" id="category_id" name="category_id">
                    <option value="">Todas</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" 
                            {% if selected_category_id|string == category.id|string %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Stock Filter (MEJORA 11) -->
            <div class="col-md-2">
                <label for="stock_filter" class="form-label small mb-1">
                    <i class="bi bi-box"></i> Stock
                </label>
                <select class="form-select" id="stock_filter" name="stock_filter">
                    <option value="">Todos</option>
                    <option value="out" {% if selected_stock_filter == 'out' %}selected{% endif %}>
                        Sin stock
                    </option>
                    <option value="low" {% if selected_stock_filter == 'low' %}selected{% endif %}>
                        Poco stock (≤ mínimo)
                    </option>
                </select>
            </div>
            
            <!-- Search Input -->
            <div class="col-md-4">
                <label for="search_q" class="form-label small mb-1">
                    <i class="bi bi-search"></i> Buscar
                </label>
                <input type="text" 
                       class="form-control" 
                       id="search_q"
                       name="q" 
                       placeholder="Nombre, SKU o código de barras..."
                       value="{{ search_query or '' }}">
            </div>
            
            <!-- Action Buttons -->
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-funnel-fill"></i> Aplicar
                </button>
                {% if search_query or selected_category_id or selected_stock_filter %}
                <a href="{{ url_for('catalog.list_products') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Limpiar
                </a>
                {% endif %}
                <a href="{{ url_for('catalog.new_product') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Nuevo
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Active Filters Info -->
{% if search_query or selected_category_id or selected_stock_filter %}
<div class="row mb-2">
    <div class="col-12">
        <div class="alert alert-info alert-dismissible fade show py-2" role="alert">
            <small>
                <strong><i class="bi bi-info-circle"></i> Filtros activos:</strong>
                {% if selected_category_id %}
                <span class="badge bg-primary">
                    Categoría: 
                    {% for cat in categories %}
                        {% if cat.id|string == selected_category_id|string %}{{ cat.name }}{% endif %}
                    {% endfor %}
                </span>
                {% endif %}
                {% if selected_stock_filter %}
                <span class="badge bg-warning text-dark">
                    Stock: 
                    {% if selected_stock_filter == 'out' %}Sin stock
                    {% elif selected_stock_filter == 'low' %}Poco stock (≤ mínimo)
                    {% endif %}
                </span>
                {% endif %}
                {% if search_query %}
                <span class="badge bg-primary">Búsqueda: "{{ search_query }}"</span>
                {% endif %}
                - Mostrando {{ products|length }} producto(s)
            </small>
            <button type="button" class="btn-close py-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endif %}

<!-- Products Table -->
<div class="row">
    <div class="col-12">
        {% if products %}
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th style="width: 80px;">Imagen</th>
                        <th>Nombre</th>
                        <th>SKU</th>
                        <th>Código Barras</th>
                        <th>Categoría</th>
                        <th>Unidad</th>
                        <th class="text-end">Precio Venta</th>
                        <th class="text-center">Stock</th>
                        <th class="text-center">Stock Mín.</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr class="{% if product.on_hand_qty == 0 %}out-of-stock{% endif %}">
                        <td>{{ product.id }}</td>
                        <td>
                            {% if product.image_path %}
                            <img src="{{ url_for('static', filename='uploads/products/' + product.image_path) }}" 
                                 alt="{{ product.name }}"
                                 class="img-thumbnail"
                                 style="width: 60px; height: 60px; object-fit: cover;">
                            {% else %}
                            <img src="{{ url_for('static', filename='img/no-image.svg') }}" 
                                 alt="Sin imagen"
                                 class="img-thumbnail"
                                 style="width: 60px; height: 60px; object-fit: cover;">
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ product.name }}</strong>
                            {% if product.on_hand_qty == 0 %}
                            <br><span class="badge bg-secondary">Sin stock</span>
                            {% endif %}
                        </td>
                        <td>{{ product.sku or '-' }}</td>
                        <td>{{ product.barcode or '-' }}</td>
                        <td>{{ product.category.name if product.category else '-' }}</td>
                        <td>
                            <span class="badge bg-info">{{ product.uom.symbol }}</span>
                            {{ product.uom.name }}
                        </td>
                        <td class="text-end">${{ "%.2f"|format(product.sale_price) }}</td>
                        <td class="text-center">
                            {% if product.on_hand_qty == 0 %}
                            <span class="badge bg-danger">0</span>
                            {% elif product.min_stock_qty > 0 and product.on_hand_qty <= product.min_stock_qty %}
                            <span class="badge bg-warning text-dark">{{ "%.2f"|format(product.on_hand_qty) }}</span>
                            {% else %}
                            <span class="badge bg-success">{{ "%.2f"|format(product.on_hand_qty) }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if product.min_stock_qty > 0 %}
                            {{ "%.2f"|format(product.min_stock_qty) }}
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if product.active %}
                            <span class="badge bg-success">Activo</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactivo</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('catalog.edit_product', product_id=product.id) }}" 
                                   class="btn btn-outline-primary"
                                   title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form method="POST" 
                                      action="{{ url_for('catalog.toggle_active', product_id=product.id) }}"
                                      style="display: inline;">
                                    <button type="submit" 
                                            class="btn btn-outline-{% if product.active %}secondary{% else %}success{% endif %}"
                                            title="{% if product.active %}Desactivar{% else %}Activar{% endif %}"
                                            onclick="return confirm('¿Está seguro de {% if product.active %}desactivar{% else %}activar{% endif %} este producto?')">
                                        <i class="bi bi-{% if product.active %}toggle-off{% else %}toggle-on{% endif %}"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <p class="text-muted">
                <strong>{{ products|length }}</strong> producto(s) encontrado(s)
                {% if search_query %}
                para la búsqueda: <strong>"{{ search_query }}"</strong>
                {% endif %}
            </p>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            {% if search_query %}
            No se encontraron productos que coincidan con: <strong>"{{ search_query }}"</strong>
            {% else %}
            No hay productos registrados. 
            <a href="{{ url_for('catalog.new_product') }}" class="alert-link">Crear el primero</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}


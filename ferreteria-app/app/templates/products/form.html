{% extends "base.html" %}

{% block title %}
{% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %} - Sistema Ferretería
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-box-seam"></i> 
            {% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %}
        </h1>
    </div>
</div>

<!-- MEJORA 9: Alert if no UOMs available -->
{% if not uoms or uoms|length == 0 %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i>
    <strong>No hay unidades de medida registradas.</strong>
    <br>
    Debe crear al menos una unidad de medida antes de poder crear productos.
    <br>
    <a href="{{ url_for('settings.list_uoms') }}" class="alert-link">
        <i class="bi bi-plus-circle"></i> Ir a Unidades de Medida
    </a>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" 
                      action="{% if action == 'new' %}{{ url_for('catalog.create_product') }}{% else %}{{ url_for('catalog.update_product', product_id=product.id) }}{% endif %}"
                      enctype="multipart/form-data">
                    
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label">
                            Nombre <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               name="name" 
                               value="{{ product.name if product else '' }}"
                               required
                               maxlength="255">
                        <div class="form-text">Nombre descriptivo del producto</div>
                    </div>

                    <!-- SKU and Barcode -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sku" class="form-label">SKU</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="sku" 
                                       name="sku" 
                                       value="{{ product.sku if product else '' }}"
                                       maxlength="100">
                                <div class="form-text">Código interno único (opcional)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="barcode" class="form-label">Código de Barras</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="barcode" 
                                       name="barcode" 
                                       value="{{ product.barcode if product else '' }}"
                                       maxlength="100">
                                <div class="form-text">Código de barras (opcional)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Category and UOM -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category_id" class="form-label">Categoría</label>
                                <select class="form-select" id="category_id" name="category_id">
                                    <option value="">Sin categoría</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" 
                                            {% if product and product.category_id == category.id %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Categoría del producto (opcional)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="uom_id" class="form-label">
                                    Unidad de Medida <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="uom_id" name="uom_id" required {% if not uoms or uoms|length == 0 %}disabled{% endif %}>
                                    <option value="">{% if uoms and uoms|length > 0 %}Seleccione una unidad{% else %}Sin unidades disponibles{% endif %}</option>
                                    {% for uom in uoms %}
                                    <option value="{{ uom.id }}" 
                                            {% if product and product.uom_id == uom.id %}selected{% endif %}>
                                        {{ uom.name }} ({{ uom.symbol }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    Unidad para medir el producto
                                    {% if not uoms or uoms|length == 0 %}
                                    <br><a href="{{ url_for('settings.list_uoms') }}" class="text-warning"><i class="bi bi-plus-circle"></i> Crear unidades de medida</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sale Price -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sale_price" class="form-label">
                                    Precio de Venta <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" 
                                           class="form-control" 
                                           id="sale_price" 
                                           name="sale_price" 
                                           value="{{ product.sale_price if product else '0.00' }}"
                                           step="0.01"
                                           min="0"
                                           required>
                                </div>
                                <div class="form-text">Precio de venta al público</div>
                            </div>
                        </div>
                        
                        <!-- MEJORA 11: Stock Mínimo -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="min_stock_qty" class="form-label">
                                    Stock Mínimo
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="min_stock_qty" 
                                       name="min_stock_qty" 
                                       value="{{ product.min_stock_qty if product else '0' }}"
                                       step="0.01"
                                       min="0">
                                <div class="form-text">
                                    Umbral de stock bajo. Si es 0, el producto no se marca como "poco stock".
                                </div>
                            </div>
                        </div>
                        
                        <!-- MEJORA 24: Stock Inicial (solo en creación) -->
                        {% if action == 'new' %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="initial_stock" class="form-label">
                                    Stock Inicial
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="initial_stock" 
                                       name="initial_stock" 
                                       value=""
                                       step="0.01"
                                       min="0"
                                       placeholder="Opcional">
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Stock inicial del producto. Si no se especifica, inicia en 0.
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Estado</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="active" 
                                           name="active"
                                           {% if not product or product.active %}checked{% endif %}>
                                    <label class="form-check-label" for="active">
                                        Producto activo
                                    </label>
                                </div>
                                <div class="form-text">Los productos inactivos no aparecen en ventas</div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Image -->
                    <div class="mb-3">
                        <label for="image" class="form-label">Imagen del Producto</label>
                        {% if product and product.image_path %}
                        <div class="mb-2">
                            <img src="{{ url_for('static', filename='uploads/products/' + product.image_path) }}" 
                                 alt="{{ product.name }}"
                                 class="img-thumbnail"
                                 style="max-width: 200px; max-height: 200px;">
                            <p class="small text-muted">Imagen actual</p>
                        </div>
                        {% endif %}
                        <input type="file" 
                               class="form-control" 
                               id="image" 
                               name="image"
                               accept="image/jpeg,image/jpg,image/png">
                        <div class="form-text">
                            Formatos permitidos: JPG, JPEG, PNG. Tamaño máximo: 2MB
                            {% if product and product.image_path %}
                            <br><small class="text-info">Si selecciona una nueva imagen, reemplazará la actual</small>
                            {% endif %}
                        </div>
                    </div>

                    {% if product %}
                    <!-- Stock Info (read-only) -->
                    <div class="alert alert-info">
                        <strong><i class="bi bi-info-circle"></i> Stock actual:</strong> 
                        {{ "%.2f"|format(product.on_hand_qty) }} {{ product.uom.symbol }}
                        <br>
                        <small class="text-muted">El stock se actualiza automáticamente con las ventas y compras</small>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('catalog.list_products') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                        <button type="submit" class="btn btn-primary" {% if not uoms or uoms|length == 0 %}disabled title="Debe crear al menos una unidad de medida"{% endif %}>
                            <i class="bi bi-save"></i> 
                            {% if action == 'new' %}Crear Producto{% else %}Guardar Cambios{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- MEJORA 24: Stock Adjustment (only in edit mode) -->
        {% if action == 'edit' and product %}
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="bi bi-box-seam"></i> Ajuste Manual de Stock
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Stock Actual:</strong></label>
                    <div class="alert alert-info mb-0">
                        <h4 class="mb-0">{{ product.on_hand_qty|num_ar }} {{ product.uom.symbol }}</h4>
                    </div>
                </div>
                
                <form method="POST" action="{{ url_for('catalog.adjust_product_stock', product_id=product.id) }}">
                    <div class="mb-3">
                        <label for="new_stock" class="form-label">
                            Nuevo Stock
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="new_stock" 
                                   name="new_stock" 
                                   value="{{ product.on_hand_qty }}"
                                   step="0.01"
                                   min="0"
                                   required>
                            <span class="input-group-text">{{ product.uom.symbol }}</span>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Setear stock a un valor específico
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-warning w-100">
                        <i class="bi bi-arrow-repeat"></i> Aplicar Ajuste
                    </button>
                </form>
                
                <div class="alert alert-secondary mt-3 mb-0 small">
                    <i class="bi bi-shield-check"></i>
                    <strong>Importante:</strong> Los ajustes manuales NO afectan el balance financiero. Solo corrigen el inventario físico.
                </div>
                
                <!-- Recent Adjustments Audit -->
                {% if recent_adjustments and recent_adjustments|length > 0 %}
                <div class="mt-3">
                    <h6 class="text-muted small">Últimos Ajustes Manuales:</h6>
                    <ul class="list-group list-group-flush small">
                        {% for adj in recent_adjustments %}
                        <li class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between">
                                <span>
                                    <i class="bi bi-clock"></i> {{ adj.date|datetime_ar }}
                                </span>
                                <span class="{% if adj.delta > 0 %}text-success{% elif adj.delta < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if adj.delta > 0 %}+{% endif %}{{ adj.delta|num_ar }}
                                </span>
                            </div>
                            {% if adj.notes %}
                            <div class="text-muted" style="font-size: 0.85em;">
                                {{ adj.notes }}
                            </div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Help Card -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-question-circle"></i> Ayuda
                </h5>
            </div>
            <div class="card-body">
                <h6>Campos requeridos:</h6>
                <ul class="small">
                    <li><strong>Nombre:</strong> Identificación del producto</li>
                    <li><strong>Unidad de Medida:</strong> Cómo se mide (UN, KG, M, etc.)</li>
                    <li><strong>Precio de Venta:</strong> Precio al público</li>
                </ul>
                
                <h6 class="mt-3">Campos opcionales:</h6>
                <ul class="small">
                    <li><strong>SKU:</strong> Código interno único</li>
                    <li><strong>Código de Barras:</strong> Para escaneo</li>
                    <li><strong>Categoría:</strong> Para organizar productos</li>
                    {% if action == 'new' %}
                    <li><strong>Stock Inicial:</strong> Stock al crear el producto</li>
                    {% endif %}
                </ul>

                <div class="alert alert-warning alert-sm mt-3">
                    <small>
                        <i class="bi bi-exclamation-triangle"></i>
                        El SKU y código de barras deben ser únicos si se proporcionan.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

